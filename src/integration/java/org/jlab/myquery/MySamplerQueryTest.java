package org.jlab.myquery;

import jakarta.json.Json;
import jakarta.json.JsonObject;
import jakarta.json.JsonReader;
import org.junit.Test;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.StringReader;
import java.net.URI;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;

import static org.junit.Assert.assertEquals;

public class MySamplerQueryTest {
    @Test
    public void basicUsageTest() throws IOException, InterruptedException {
        HttpClient client = HttpClient.newHttpClient();
        HttpRequest request = HttpRequest.newBuilder().uri(URI.create("http://localhost:8080/myquery/mysampler?c=channel1&b=2019-08-12+23%3A59%3A00&n=5&s=15000&m=docker&f=6&v=&x=n")).build();
        HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());
        HttpRequest request2 = HttpRequest.newBuilder().uri(URI.create("http://localhost:8080/myquery/mysampler?c=channel1&b=2019-08-12+23%3A59%3A00&n=5&s=15000&m=docker&f=6&v=&x=s")).build();
        HttpResponse<String> response2 = client.send(request, HttpResponse.BodyHandlers.ofString());
        HttpRequest request3 = HttpRequest.newBuilder().uri(URI.create("http://localhost:8080/myquery/mysampler?c=channel1&b=2019-08-12+23%3A59%3A00&n=5&s=15000&m=docker&f=6&v=")).build();
        HttpResponse<String> response3 = client.send(request, HttpResponse.BodyHandlers.ofString());

        assertEquals(200, response.statusCode());
        assertEquals(200, response2.statusCode());
        assertEquals(200, response3.statusCode());

        String jsonString = """
                {
                   "channels": {
                     "channel1": {
                       "metadata": {
                         "name": "channel1",
                         "datatype": "DBR_DOUBLE",
                         "datasize": 1,
                         "datahost": "mya",
                         "ioc": null,
                         "active": true
                       },
                       "data": [
                         {
                           "d": "2019-08-12 23:59:00.000000",
                           "v": 94.550102
                         },
                         {
                           "d": "2019-08-12 23:59:15.000000",
                           "v": 94.987701
                         },
                         {
                           "d": "2019-08-12 23:59:30.000000",
                           "v": 94.651604
                         },
                         {
                           "d": "2019-08-12 23:59:45.000000",
                           "v": 94.292702
                         },
                         {
                           "d": "2019-08-13 00:00:00.000000",
                           "v": 95.179703
                         }
                       ],
                       "returnCount": 5
                     }
                   }
                 }""";

        String exp;
        try (JsonReader r = Json.createReader(new StringReader(jsonString))) {
            exp = r.readObject().toString();
        }

        try (JsonReader reader = Json.createReader(new StringReader(response.body()))) {
            JsonObject json = reader.readObject();
            assertEquals(exp, json.toString());
        }
        try (JsonReader reader = Json.createReader(new StringReader(response2.body()))) {
            JsonObject json = reader.readObject();
            assertEquals(exp, json.toString());
        }

        try (JsonReader reader = Json.createReader(new StringReader(response3.body()))) {
            JsonObject json = reader.readObject();
            assertEquals(exp, json.toString());
        }

    }

    @Test
    public void multiChannelTest() throws IOException, InterruptedException {
        HttpClient client = HttpClient.newHttpClient();
        HttpRequest request = HttpRequest.newBuilder().uri(URI.create("http://localhost:8080/myquery/mysampler?c=channel1,channel2,channel3,channel4&b=2019-08-12+23%3A59%3A00&n=5&s=15000&m=docker&f=6&v=")).build();
        HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());

        assertEquals(200, response.statusCode());

        String jsonString = """
                {
                  "channels": {
                    "channel1": {
                      "metadata": {
                        "name": "channel1",
                        "datatype": "DBR_DOUBLE",
                        "datasize": 1,
                        "datahost": "mya",
                        "ioc": null,
                        "active": true
                      },
                      "data": [
                        {
                          "d": "2019-08-12 23:59:00.000000",
                          "v": 94.550102
                        },
                        {
                          "d": "2019-08-12 23:59:15.000000",
                          "v": 94.987701
                        },
                        {
                          "d": "2019-08-12 23:59:30.000000",
                          "v": 94.651604
                        },
                        {
                          "d": "2019-08-12 23:59:45.000000",
                          "v": 94.292702
                        },
                        {
                          "d": "2019-08-13 00:00:00.000000",
                          "v": 95.179703
                        }
                      ],
                      "returnCount": 5
                    },
                    "channel2": {
                      "metadata": {
                        "name": "channel2",
                        "datatype": "DBR_ENUM",
                        "datasize": 1,
                        "datahost": "mya",
                        "ioc": null,
                        "active": true
                      },
                      "labels": [
                        {
                          "d": "2016-08-12 13:00:49.000000",
                          "value": [
                            "BEAM SYNC ONLY",
                            "PULSE MODE VL",
                            "TUNE MODE",
                            "CW MODE (DC)",
                            "USER MODE"
                          ]
                        }
                      ],
                      "data": [
                        {
                          "d": "2019-08-12 23:59:00.000000",
                          "v": 3
                        },
                        {
                          "d": "2019-08-12 23:59:15.000000",
                          "v": 3
                        },
                        {
                          "d": "2019-08-12 23:59:30.000000",
                          "v": 3
                        },
                        {
                          "d": "2019-08-12 23:59:45.000000",
                          "v": 3
                        },
                        {
                          "d": "2019-08-13 00:00:00.000000",
                          "v": 3
                        }
                      ],
                      "returnCount": 5
                    },
                    "channel3": {
                      "metadata": {
                        "name": "channel3",
                        "datatype": "DBR_DOUBLE",
                        "datasize": 168,
                        "datahost": "mya",
                        "ioc": null,
                        "active": true
                      },
                      "data": [
                        {
                          "d": "2019-08-12 23:59:00.000000",
                          "v": [
                            "1565670000",
                            "1565660000",
                            "1565660000",
                            "1565650000",
                            "1565650000",
                            "1565650000",
                            "1565640000",
                            "1565640000",
                            "1565640000",
                            "1565630000",
                            "1565630000",
                            "1565630000",
                            "1565620000",
                            "1565620000",
                            "1565610000",
                            "1565610000",
                            "1565610000",
                            "1565600000",
                            "1565600000",
                            "1565600000",
                            "1565590000",
                            "1565590000",
                            "1565590000",
                            "1565580000",
                            "1565580000",
                            "1565580000",
                            "1565570000",
                            "1565570000",
                            "1565560000",
                            "1565560000",
                            "1565560000",
                            "1565550000",
                            "1565550000",
                            "1565550000",
                            "1565540000",
                            "1565540000",
                            "1565540000",
                            "1565530000",
                            "1565530000",
                            "1565520000",
                            "1565520000",
                            "1565520000",
                            "1565510000",
                            "1565510000",
                            "1565510000",
                            "1565500000",
                            "1565500000",
                            "1565500000",
                            "1565490000",
                            "1565490000",
                            "1565490000",
                            "1565480000",
                            "1565480000",
                            "1565470000",
                            "1565470000",
                            "1565470000",
                            "1565460000",
                            "1565460000",
                            "1565460000",
                            "1565450000",
                            "1565450000",
                            "1565450000",
                            "1565440000",
                            "1565440000",
                            "1565430000",
                            "1565430000",
                            "1565430000",
                            "1565420000",
                            "1565420000",
                            "1565420000",
                            "1565410000",
                            "1565410000",
                            "1565410000",
                            "1565400000",
                            "1565400000",
                            "1565400000",
                            "1565390000",
                            "1565390000",
                            "1565380000",
                            "1565380000",
                            "1565380000",
                            "1565370000",
                            "1565370000",
                            "1565370000",
                            "1565360000",
                            "1565360000",
                            "1565360000",
                            "1565350000",
                            "1565350000",
                            "1565340000",
                            "1565340000",
                            "1565340000",
                            "1565330000",
                            "1565330000",
                            "1565330000",
                            "1565320000",
                            "1565320000",
                            "1565320000",
                            "1565310000",
                            "1565310000",
                            "1565310000",
                            "1565300000",
                            "1565300000",
                            "1565290000",
                            "1565290000",
                            "1565290000",
                            "1565280000",
                            "1565280000",
                            "1565280000",
                            "1565270000",
                            "1565270000",
                            "1565270000",
                            "1565260000",
                            "1565260000",
                            "1565250000",
                            "1565250000",
                            "1565250000",
                            "1565240000",
                            "1565240000",
                            "1565240000",
                            "1565230000",
                            "1565230000",
                            "1565230000",
                            "1565220000",
                            "1565220000",
                            "1565220000",
                            "1565210000",
                            "1565210000",
                            "1565200000",
                            "1565200000",
                            "1565200000",
                            "1565190000",
                            "1565190000",
                            "1565190000",
                            "1565180000",
                            "1565180000",
                            "1565180000",
                            "1565170000",
                            "1565170000",
                            "1565160000",
                            "1565160000",
                            "1565160000",
                            "1565150000",
                            "1565150000",
                            "1565150000",
                            "1565140000",
                            "1565140000",
                            "1565140000",
                            "1565130000",
                            "1565130000",
                            "1565130000",
                            "1565120000",
                            "1565120000",
                            "1565110000",
                            "1565110000",
                            "1565110000",
                            "1565100000",
                            "1565100000",
                            "1565100000",
                            "1565090000",
                            "1565090000",
                            "1565090000",
                            "1565080000",
                            "1565080000",
                            "1565070000",
                            "1565070000",
                            "1565070000",
                            "1565060000"
                          ]
                        },
                        {
                          "d": "2019-08-12 23:59:15.000000",
                          "v": [
                            "1565670000",
                            "1565660000",
                            "1565660000",
                            "1565650000",
                            "1565650000",
                            "1565650000",
                            "1565640000",
                            "1565640000",
                            "1565640000",
                            "1565630000",
                            "1565630000",
                            "1565630000",
                            "1565620000",
                            "1565620000",
                            "1565610000",
                            "1565610000",
                            "1565610000",
                            "1565600000",
                            "1565600000",
                            "1565600000",
                            "1565590000",
                            "1565590000",
                            "1565590000",
                            "1565580000",
                            "1565580000",
                            "1565580000",
                            "1565570000",
                            "1565570000",
                            "1565560000",
                            "1565560000",
                            "1565560000",
                            "1565550000",
                            "1565550000",
                            "1565550000",
                            "1565540000",
                            "1565540000",
                            "1565540000",
                            "1565530000",
                            "1565530000",
                            "1565520000",
                            "1565520000",
                            "1565520000",
                            "1565510000",
                            "1565510000",
                            "1565510000",
                            "1565500000",
                            "1565500000",
                            "1565500000",
                            "1565490000",
                            "1565490000",
                            "1565490000",
                            "1565480000",
                            "1565480000",
                            "1565470000",
                            "1565470000",
                            "1565470000",
                            "1565460000",
                            "1565460000",
                            "1565460000",
                            "1565450000",
                            "1565450000",
                            "1565450000",
                            "1565440000",
                            "1565440000",
                            "1565430000",
                            "1565430000",
                            "1565430000",
                            "1565420000",
                            "1565420000",
                            "1565420000",
                            "1565410000",
                            "1565410000",
                            "1565410000",
                            "1565400000",
                            "1565400000",
                            "1565400000",
                            "1565390000",
                            "1565390000",
                            "1565380000",
                            "1565380000",
                            "1565380000",
                            "1565370000",
                            "1565370000",
                            "1565370000",
                            "1565360000",
                            "1565360000",
                            "1565360000",
                            "1565350000",
                            "1565350000",
                            "1565340000",
                            "1565340000",
                            "1565340000",
                            "1565330000",
                            "1565330000",
                            "1565330000",
                            "1565320000",
                            "1565320000",
                            "1565320000",
                            "1565310000",
                            "1565310000",
                            "1565310000",
                            "1565300000",
                            "1565300000",
                            "1565290000",
                            "1565290000",
                            "1565290000",
                            "1565280000",
                            "1565280000",
                            "1565280000",
                            "1565270000",
                            "1565270000",
                            "1565270000",
                            "1565260000",
                            "1565260000",
                            "1565250000",
                            "1565250000",
                            "1565250000",
                            "1565240000",
                            "1565240000",
                            "1565240000",
                            "1565230000",
                            "1565230000",
                            "1565230000",
                            "1565220000",
                            "1565220000",
                            "1565220000",
                            "1565210000",
                            "1565210000",
                            "1565200000",
                            "1565200000",
                            "1565200000",
                            "1565190000",
                            "1565190000",
                            "1565190000",
                            "1565180000",
                            "1565180000",
                            "1565180000",
                            "1565170000",
                            "1565170000",
                            "1565160000",
                            "1565160000",
                            "1565160000",
                            "1565150000",
                            "1565150000",
                            "1565150000",
                            "1565140000",
                            "1565140000",
                            "1565140000",
                            "1565130000",
                            "1565130000",
                            "1565130000",
                            "1565120000",
                            "1565120000",
                            "1565110000",
                            "1565110000",
                            "1565110000",
                            "1565100000",
                            "1565100000",
                            "1565100000",
                            "1565090000",
                            "1565090000",
                            "1565090000",
                            "1565080000",
                            "1565080000",
                            "1565070000",
                            "1565070000",
                            "1565070000",
                            "1565060000"
                          ]
                        },
                        {
                          "d": "2019-08-12 23:59:30.000000",
                          "v": [
                            "1565670000",
                            "1565660000",
                            "1565660000",
                            "1565650000",
                            "1565650000",
                            "1565650000",
                            "1565640000",
                            "1565640000",
                            "1565640000",
                            "1565630000",
                            "1565630000",
                            "1565630000",
                            "1565620000",
                            "1565620000",
                            "1565610000",
                            "1565610000",
                            "1565610000",
                            "1565600000",
                            "1565600000",
                            "1565600000",
                            "1565590000",
                            "1565590000",
                            "1565590000",
                            "1565580000",
                            "1565580000",
                            "1565580000",
                            "1565570000",
                            "1565570000",
                            "1565560000",
                            "1565560000",
                            "1565560000",
                            "1565550000",
                            "1565550000",
                            "1565550000",
                            "1565540000",
                            "1565540000",
                            "1565540000",
                            "1565530000",
                            "1565530000",
                            "1565520000",
                            "1565520000",
                            "1565520000",
                            "1565510000",
                            "1565510000",
                            "1565510000",
                            "1565500000",
                            "1565500000",
                            "1565500000",
                            "1565490000",
                            "1565490000",
                            "1565490000",
                            "1565480000",
                            "1565480000",
                            "1565470000",
                            "1565470000",
                            "1565470000",
                            "1565460000",
                            "1565460000",
                            "1565460000",
                            "1565450000",
                            "1565450000",
                            "1565450000",
                            "1565440000",
                            "1565440000",
                            "1565430000",
                            "1565430000",
                            "1565430000",
                            "1565420000",
                            "1565420000",
                            "1565420000",
                            "1565410000",
                            "1565410000",
                            "1565410000",
                            "1565400000",
                            "1565400000",
                            "1565400000",
                            "1565390000",
                            "1565390000",
                            "1565380000",
                            "1565380000",
                            "1565380000",
                            "1565370000",
                            "1565370000",
                            "1565370000",
                            "1565360000",
                            "1565360000",
                            "1565360000",
                            "1565350000",
                            "1565350000",
                            "1565340000",
                            "1565340000",
                            "1565340000",
                            "1565330000",
                            "1565330000",
                            "1565330000",
                            "1565320000",
                            "1565320000",
                            "1565320000",
                            "1565310000",
                            "1565310000",
                            "1565310000",
                            "1565300000",
                            "1565300000",
                            "1565290000",
                            "1565290000",
                            "1565290000",
                            "1565280000",
                            "1565280000",
                            "1565280000",
                            "1565270000",
                            "1565270000",
                            "1565270000",
                            "1565260000",
                            "1565260000",
                            "1565250000",
                            "1565250000",
                            "1565250000",
                            "1565240000",
                            "1565240000",
                            "1565240000",
                            "1565230000",
                            "1565230000",
                            "1565230000",
                            "1565220000",
                            "1565220000",
                            "1565220000",
                            "1565210000",
                            "1565210000",
                            "1565200000",
                            "1565200000",
                            "1565200000",
                            "1565190000",
                            "1565190000",
                            "1565190000",
                            "1565180000",
                            "1565180000",
                            "1565180000",
                            "1565170000",
                            "1565170000",
                            "1565160000",
                            "1565160000",
                            "1565160000",
                            "1565150000",
                            "1565150000",
                            "1565150000",
                            "1565140000",
                            "1565140000",
                            "1565140000",
                            "1565130000",
                            "1565130000",
                            "1565130000",
                            "1565120000",
                            "1565120000",
                            "1565110000",
                            "1565110000",
                            "1565110000",
                            "1565100000",
                            "1565100000",
                            "1565100000",
                            "1565090000",
                            "1565090000",
                            "1565090000",
                            "1565080000",
                            "1565080000",
                            "1565070000",
                            "1565070000",
                            "1565070000",
                            "1565060000"
                          ]
                        },
                        {
                          "d": "2019-08-12 23:59:45.000000",
                          "v": [
                            "1565670000",
                            "1565660000",
                            "1565660000",
                            "1565650000",
                            "1565650000",
                            "1565650000",
                            "1565640000",
                            "1565640000",
                            "1565640000",
                            "1565630000",
                            "1565630000",
                            "1565630000",
                            "1565620000",
                            "1565620000",
                            "1565610000",
                            "1565610000",
                            "1565610000",
                            "1565600000",
                            "1565600000",
                            "1565600000",
                            "1565590000",
                            "1565590000",
                            "1565590000",
                            "1565580000",
                            "1565580000",
                            "1565580000",
                            "1565570000",
                            "1565570000",
                            "1565560000",
                            "1565560000",
                            "1565560000",
                            "1565550000",
                            "1565550000",
                            "1565550000",
                            "1565540000",
                            "1565540000",
                            "1565540000",
                            "1565530000",
                            "1565530000",
                            "1565520000",
                            "1565520000",
                            "1565520000",
                            "1565510000",
                            "1565510000",
                            "1565510000",
                            "1565500000",
                            "1565500000",
                            "1565500000",
                            "1565490000",
                            "1565490000",
                            "1565490000",
                            "1565480000",
                            "1565480000",
                            "1565470000",
                            "1565470000",
                            "1565470000",
                            "1565460000",
                            "1565460000",
                            "1565460000",
                            "1565450000",
                            "1565450000",
                            "1565450000",
                            "1565440000",
                            "1565440000",
                            "1565430000",
                            "1565430000",
                            "1565430000",
                            "1565420000",
                            "1565420000",
                            "1565420000",
                            "1565410000",
                            "1565410000",
                            "1565410000",
                            "1565400000",
                            "1565400000",
                            "1565400000",
                            "1565390000",
                            "1565390000",
                            "1565380000",
                            "1565380000",
                            "1565380000",
                            "1565370000",
                            "1565370000",
                            "1565370000",
                            "1565360000",
                            "1565360000",
                            "1565360000",
                            "1565350000",
                            "1565350000",
                            "1565340000",
                            "1565340000",
                            "1565340000",
                            "1565330000",
                            "1565330000",
                            "1565330000",
                            "1565320000",
                            "1565320000",
                            "1565320000",
                            "1565310000",
                            "1565310000",
                            "1565310000",
                            "1565300000",
                            "1565300000",
                            "1565290000",
                            "1565290000",
                            "1565290000",
                            "1565280000",
                            "1565280000",
                            "1565280000",
                            "1565270000",
                            "1565270000",
                            "1565270000",
                            "1565260000",
                            "1565260000",
                            "1565250000",
                            "1565250000",
                            "1565250000",
                            "1565240000",
                            "1565240000",
                            "1565240000",
                            "1565230000",
                            "1565230000",
                            "1565230000",
                            "1565220000",
                            "1565220000",
                            "1565220000",
                            "1565210000",
                            "1565210000",
                            "1565200000",
                            "1565200000",
                            "1565200000",
                            "1565190000",
                            "1565190000",
                            "1565190000",
                            "1565180000",
                            "1565180000",
                            "1565180000",
                            "1565170000",
                            "1565170000",
                            "1565160000",
                            "1565160000",
                            "1565160000",
                            "1565150000",
                            "1565150000",
                            "1565150000",
                            "1565140000",
                            "1565140000",
                            "1565140000",
                            "1565130000",
                            "1565130000",
                            "1565130000",
                            "1565120000",
                            "1565120000",
                            "1565110000",
                            "1565110000",
                            "1565110000",
                            "1565100000",
                            "1565100000",
                            "1565100000",
                            "1565090000",
                            "1565090000",
                            "1565090000",
                            "1565080000",
                            "1565080000",
                            "1565070000",
                            "1565070000",
                            "1565070000",
                            "1565060000"
                          ]
                        },
                        {
                          "d": "2019-08-13 00:00:00.000000",
                          "v": [
                            "1565670000",
                            "1565660000",
                            "1565660000",
                            "1565650000",
                            "1565650000",
                            "1565650000",
                            "1565640000",
                            "1565640000",
                            "1565640000",
                            "1565630000",
                            "1565630000",
                            "1565630000",
                            "1565620000",
                            "1565620000",
                            "1565610000",
                            "1565610000",
                            "1565610000",
                            "1565600000",
                            "1565600000",
                            "1565600000",
                            "1565590000",
                            "1565590000",
                            "1565590000",
                            "1565580000",
                            "1565580000",
                            "1565580000",
                            "1565570000",
                            "1565570000",
                            "1565560000",
                            "1565560000",
                            "1565560000",
                            "1565550000",
                            "1565550000",
                            "1565550000",
                            "1565540000",
                            "1565540000",
                            "1565540000",
                            "1565530000",
                            "1565530000",
                            "1565520000",
                            "1565520000",
                            "1565520000",
                            "1565510000",
                            "1565510000",
                            "1565510000",
                            "1565500000",
                            "1565500000",
                            "1565500000",
                            "1565490000",
                            "1565490000",
                            "1565490000",
                            "1565480000",
                            "1565480000",
                            "1565470000",
                            "1565470000",
                            "1565470000",
                            "1565460000",
                            "1565460000",
                            "1565460000",
                            "1565450000",
                            "1565450000",
                            "1565450000",
                            "1565440000",
                            "1565440000",
                            "1565430000",
                            "1565430000",
                            "1565430000",
                            "1565420000",
                            "1565420000",
                            "1565420000",
                            "1565410000",
                            "1565410000",
                            "1565410000",
                            "1565400000",
                            "1565400000",
                            "1565400000",
                            "1565390000",
                            "1565390000",
                            "1565380000",
                            "1565380000",
                            "1565380000",
                            "1565370000",
                            "1565370000",
                            "1565370000",
                            "1565360000",
                            "1565360000",
                            "1565360000",
                            "1565350000",
                            "1565350000",
                            "1565340000",
                            "1565340000",
                            "1565340000",
                            "1565330000",
                            "1565330000",
                            "1565330000",
                            "1565320000",
                            "1565320000",
                            "1565320000",
                            "1565310000",
                            "1565310000",
                            "1565310000",
                            "1565300000",
                            "1565300000",
                            "1565290000",
                            "1565290000",
                            "1565290000",
                            "1565280000",
                            "1565280000",
                            "1565280000",
                            "1565270000",
                            "1565270000",
                            "1565270000",
                            "1565260000",
                            "1565260000",
                            "1565250000",
                            "1565250000",
                            "1565250000",
                            "1565240000",
                            "1565240000",
                            "1565240000",
                            "1565230000",
                            "1565230000",
                            "1565230000",
                            "1565220000",
                            "1565220000",
                            "1565220000",
                            "1565210000",
                            "1565210000",
                            "1565200000",
                            "1565200000",
                            "1565200000",
                            "1565190000",
                            "1565190000",
                            "1565190000",
                            "1565180000",
                            "1565180000",
                            "1565180000",
                            "1565170000",
                            "1565170000",
                            "1565160000",
                            "1565160000",
                            "1565160000",
                            "1565150000",
                            "1565150000",
                            "1565150000",
                            "1565140000",
                            "1565140000",
                            "1565140000",
                            "1565130000",
                            "1565130000",
                            "1565130000",
                            "1565120000",
                            "1565120000",
                            "1565110000",
                            "1565110000",
                            "1565110000",
                            "1565100000",
                            "1565100000",
                            "1565100000",
                            "1565090000",
                            "1565090000",
                            "1565090000",
                            "1565080000",
                            "1565080000",
                            "1565070000",
                            "1565070000",
                            "1565070000",
                            "1565060000"
                          ]
                        }
                      ],
                      "returnCount": 5
                    },
                    "channel4": {
                      "metadata": {
                        "name": "channel4",
                        "datatype": "DBR_DOUBLE",
                        "datasize": 1,
                        "datahost": "mya",
                        "ioc": null,
                        "active": true
                      },
                      "data": [
                        {
                          "d": "2019-08-12 23:59:00.000000",
                          "x": true,
                          "t": "UNDEFINED"
                        },
                        {
                          "d": "2019-08-12 23:59:15.000000",
                          "x": true,
                          "t": "UNDEFINED"
                        },
                        {
                          "d": "2019-08-12 23:59:30.000000",
                          "x": true,
                          "t": "UNDEFINED"
                        },
                        {
                          "d": "2019-08-12 23:59:45.000000",
                          "x": true,
                          "t": "UNDEFINED"
                        },
                        {
                          "d": "2019-08-13 00:00:00.000000",
                          "x": true,
                          "t": "UNDEFINED"
                        }
                      ],
                      "returnCount": 5
                    }
                  }
                }""";
        String exp;
        try (JsonReader r = Json.createReader(new StringReader(jsonString))) {
            exp = r.readObject().toString();
        }

        try (JsonReader reader = Json.createReader(new StringReader(response.body()))) {
            JsonObject json = reader.readObject();
            assertEquals(exp, json.toString());
        }
    }

    @Test
    public void jsonpTest() throws IOException, InterruptedException {
        HttpClient client = HttpClient.newHttpClient();
        HttpRequest request = HttpRequest.newBuilder().uri(URI.create("http://localhost:8080/myquery/mysampler?c=channel1,channel2&b=2019-08-12+23%3A59%3A00&n=5&s=15000&m=docker&f=6&v=&jsonp=1234test")).build();
        HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());

        assertEquals(200, response.statusCode());

        String exp = "1234test({\"channels\":{\"channel1\":{\"metadata\":{\"name\":\"channel1\",\"datatype\":\"DBR_DOUBLE\",\"datasize\":1,\"datahost\":\"mya\",\"ioc\":null,\"active\":true},\"data\":[{\"d\":\"2019-08-12 23:59:00.000000\",\"v\":94.5501},{\"d\":\"2019-08-12 23:59:15.000000\",\"v\":94.9877},{\"d\":\"2019-08-12 23:59:30.000000\",\"v\":94.6516},{\"d\":\"2019-08-12 23:59:45.000000\",\"v\":94.2927},{\"d\":\"2019-08-13 00:00:00.000000\",\"v\":95.1797}],\"returnCount\":5},\"channel2\":{\"metadata\":{\"name\":\"channel2\",\"datatype\":\"DBR_ENUM\",\"datasize\":1,\"datahost\":\"mya\",\"ioc\":null,\"active\":true},\"labels\":[{\"d\":\"2016-08-12 13:00:49.000000\",\"value\":[\"BEAM SYNC ONLY\",\"PULSE MODE VL\",\"TUNE MODE\",\"CW MODE (DC)\",\"USER MODE\"]}],\"data\":[{\"d\":\"2019-08-12 23:59:00.000000\",\"v\":3},{\"d\":\"2019-08-12 23:59:15.000000\",\"v\":3},{\"d\":\"2019-08-12 23:59:30.000000\",\"v\":3},{\"d\":\"2019-08-12 23:59:45.000000\",\"v\":3},{\"d\":\"2019-08-13 00:00:00.000000\",\"v\":3}],\"returnCount\":5}}});";

        String result;
        try (BufferedReader reader = new BufferedReader(new StringReader(response.body()))) {
            result = reader.readLine();
            assertEquals(exp, result);
        }
    }


    @Test
    public void repeatUsageTest() throws IOException, InterruptedException {
        // Check that we don't have some sort of resource exhaustion.  Hit this bug in development and thought best to
        // include explicit test for it.
        HttpClient client = HttpClient.newHttpClient();
        // Test the stream strategy
        for (int i = 0; i < 20; i++) {
            HttpRequest request = HttpRequest.newBuilder().uri(URI.create("http://localhost:8080/myquery/mysampler?c=channel1&b=2019-08-12+23%3A59%3A00&n=5&s=15000&m=docker&f=6&v=&s=s")).build();
            HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());
            assertEquals(200, response.statusCode());
        }

        // Test the n_queries strategy
        for (int i = 0; i < 20; i++) {
            HttpRequest request = HttpRequest.newBuilder().uri(URI.create("http://localhost:8080/myquery/mysampler?c=channel1&b=2019-08-12+23%3A59%3A00&n=5&s=15000&m=docker&f=6&v=&s=n")).build();
            HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());
            assertEquals(200, response.statusCode());
        }

    }
}
